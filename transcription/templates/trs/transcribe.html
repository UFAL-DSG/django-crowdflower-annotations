{% extends "base.html" %}
{% load url from future %}

{% block head %}
<script src="{{ MEDIA_URL }}js/easyXDM.min.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
	var socket = new easyXDM.Socket({
			onReady:	function(){
					socket.postMessage(document.body.scrollHeight);
		 }
	});
//-->
</script>
<link href="{{ MEDIA_URL }}css/jquery-ui.css" rel="stylesheet" type="text/css"/>
<style type="text/css">
hr {
	margin: 20px;
}

form label {
		vertical-align: top;
		display: block;
}

div.success_msg {
	border: 2px solid green;
}

div#ins, div#dg {
	display: inline-block;
	vertical-align: top;
}

div#ins {
	margin: 1em 2ex 0ex 2ex;
	min-width: 45em;
	max-width: 55em;
}

div#dg {
	width: 60em;
	max-width: 60em;
}

#id_notes {
	margin-left: auto;
	margin-right: auto;
}

input#ins-hide {
	float: right;
	margin-right: 1em;
}

.quote {
	margin-left: auto;
	margin-right: auto;
	width: 80%;
}

.no {
	color: red;
	font-weight: bold;
}

.yes {
	color: green;
	font-weight: bold;
}

.centering {
	padding: 0pt;
	text-align: center;
}

ul.errorlist {
		color: red;
		display:block;
}

div#task {
	xborder: 1px solid red;
	xbackground-color: #FFCCCC;
	margin-top: 20px;
	margin: 5px;
	padding: 5px;
}

div#goal {
	border: 1px solid yellow;
	background-color: #FFFFCC;
	margin-top: 20px;
	margin: 5px;
	padding: 5px;
}

p.tasktext {
	font-weight: bold;
	color: red;
	padding-top: 5px !important;
}

p.goaltext, #task p {
	padding: 0px;
	margin: 0px;
}

.speaker {
	position: relative;
	left: -1em;
	font-weight: bold;
}


/* Tables */
table.booktabs	{
	margin-top: 1em;
	margin-bottom: 2em;
	border-bottom: 1.5pt solid;
	border-top: 1.5pt solid;
	border-spacing: 1em;
	border-collapse: collapse;
}

td, th {
	padding: 5px;
}

table.booktabs td + td, table.booktabs th + th
{
	padding-left: 2em;
}

table.booktabs tr:first-child {
	border-bottom: 1pt solid;
}

table.booktabs.noheader tr:first-child {
	border-bottom: inherit;
}

form li {
	list-style-type: none;
	padding-top: 10px;
}

p.system { color: blue; }
p.user { color: orange; }

.errors {
		background-color: red;
		color: white;
}

#submit {
	width: 13em;
	height: 3em;
	font-weight: bold;
}

</style>
<script src="{{ MEDIA_URL }}js/jquery.js"></script>
{% if USE_ACCORDION %}
<script src="{{ MEDIA_URL }}js/jquery.multi-open-accordion.js"></script>
{% endif %}
<script src="{{ MEDIA_URL }}js/jquery-ui.min.js"></script>
<script src="{{ MEDIA_URL }}js/jquery.jplayer.min.js"></script>
<script type="text/javascript">
		String.prototype.endsWith = function(suffix) {
				return this.indexOf(suffix, this.length - suffix.length) !== -1;
		};
		var curr_btnid = "";

		var beenPlaying = false;

	function getPlayer(pid) {
			var obj = document.getElementById(pid);
			if (obj.doPlay) return obj;
			for(i=0; i<obj.childNodes.length; i++) {
					var child = obj.childNodes[i];
					if (child.tagName == "EMBED") return child;
			}
	}

	{% if USE_ACCORDION %}
	function NextPhase() {
			var PrevIndex = $('div .current');
			var NextIndex = PrevIndex.next().next();
			PrevIndex.removeClass("current");
			NextIndex.addClass("current");
			//NextIndex.click();

			NextIndex.removeClass("ui-state-disabled");
			if(!NextIndex.hasClass("ui-state-active"))
					NextIndex.click();
	}
	{% endif %}

	function PlayerStopped() {
			if(beenPlaying) {
					beenPlaying = false;
					$('#' + curr_btnid).text("Play");

					{% if USE_ACCORDION %}
					NextPhase();
					{% endif %}
			}
	}

	function PlayerPlaying() {
			beenPlaying = true;
	}

	function init_player(name) {
			var player = getPlayer(name);
			var init = function() { init_player(name); }
			if (!player || !player.attachHandler) setTimeout(init, 100); // Wait for load
			else {
					player.attachHandler("PLAYER_PLAYING", "PlayerPlaying", "STOPPED");
					player.attachHandler("PLAYER_STOPPED", "PlayerStopped", "STOPPED");
					//window.TinyWav = new TinyWav('TinyWavBlock', 0.01);
			}
	}

	function deinit_player(name) {
			var player = getPlayer(name);
			var init = function() { init_player(name); }
			if (!player || !player.attachHandler) setTimeout(init, 100); // Wait for load
			else {
					player.removeHandler(PlayerStopped);
			}
	}

	var accordion, hideButton, insAreShown = true;

	// Callback function called when the instructions have been hidden.
	function insHidden() {
		insAreShown = false;
		hideButton.value = "Show instructions";
		hideButton.disabled = false;
	}

	// Callback function called when the instructions have been shown.
	function insShown() {
		insAreShown = true;
		hideButton.value = "Hide instructions";
		hideButton.disabled = false;
	}

	$(document).ready(function() {
			{% if USE_ACCORDION %}
			accordion = $("#phases").multiAccordion({active: 0});
			{% endif %}
			{% if "accent" in EXTRA_QUESTIONS %}
			$("#accent_spec").slideUp();
			{% endif %}

			$("#player").jPlayer( {
					swfPath: "{{ MEDIA_URL }}flash/",
					supplied: "wav",
					ended: function() {
							PlayerStopped();
					}
			});

			{% if USE_ACCORDION %}
			$("#turn_1").removeClass("ui-state-disabled");
			{% endif %}

			{% if "accent" in EXTRA_QUESTIONS %}
			var native_accent = document.getElementById("id_accent_native");
			var other_accent = document.getElementById("id_accent_other");
			var accent_name = document.getElementById("id_accent_name");
			$("#id_accent_native").change(function() {
				if(native_accent.checked)
				{
					$("#accent_spec").slideUp();
				}
			});
			$("#id_accent_other").change(function() {
				if(other_accent.checked)
				{
					$("#accent_spec").slideDown();
				}
			});
			{% endif %}

			$("#submit").click(function() {
					// Check that all fields (text areas) are filled in.
					var res = 1;
					var fields = document.getElementsByTagName("textarea");
					for(var fldIdx = 0; fldIdx < fields.length; fldIdx++)
					{
						field = fields[fldIdx];
						if(field.id === "id_notes")
						{
							continue;
						}
						if(fields[fldIdx].value.search(/\w/) === -1)
						{
							res = 0;
							break;
						}
					}

					if(res !== 1) {
						msg = "Please fill in all the input fields.\n\
									In case you heard just silence, type \"(sil)\" \
									into the corresponding field.\n\
									See Instructions for transcription of other \
									non-speech sounds.";
						alert(msg);
						return false;
					}
					
					{% if "accent" in EXTRA_QUESTIONS %}
					if(other_accent.checked && accent_name.value.search(/\w/) === -1)
					{
						msg = "You say the speaker had a non-native English accent.\n";
						msg += "Please, specify what accent you think he/she had.";
						alert(msg);
						return false;
					}
					{% endif %}
					return true;
			});

			hideButton = document.getElementById("ins-hide");
			$("input#ins-hide").click(function() {
				hideButton.disabled = true;
				if(insAreShown)
				{
					$("div#ins-inner").slideUp("fast", "swing", insHidden);
				}
				else
				{
					$("div#ins-inner").slideDown("fast", "swing", insShown);
				}
			});
	});

	function play_now(btnid, phase, f) {
		curr_btnid = btnid;
		{% if USE_ACCORDION %}
		$(".current").removeClass("current");
		$("#" + phase).addClass("current");
		{% endif %}
		try{
				PlayerPlaying();
				$('#' + btnid).text("Playing...");
				$("#player").jPlayer("setMedia", {wav: f}).jPlayer("play");
		} catch(E){
				alert(E);
		}
	}

	function pseudo_play_now(btnid, phase, f) {
			curr_btnid = btnid;
			{% if USE_ACCORDION %}
			$(".current").removeClass("current");
			$("#" + phase).addClass("current");
			NextPhase();
			{% endif %}
	}
</script>

{% endblock head %}


{% block content %}


<span>
	<div id="ins">
		<div class="centering">
			<img src="{{ MEDIA_URL }}img/logo_ufal_73_transparent.png" width="91" 
			height="73" />
		</div>

		<h2>Instructions
			<input type="button" id="ins-hide" value="Hide instructions"></input>
		</h2>
		
		<div id="ins-inner">
			<p>
			The recordings and input fields will be enabled gradually, each time 
			you finish listening to the previous recording. You can move between 
			the Play/Next buttons and text areas using the tab key. You will be 
			able to replay each sound any time later.
			</p>

			{% for fname in instruction_includes %}
				{% include fname %}
			{% endfor %}

		</div>
	</div>

	<div id="dg">
		{% if success == "True" %}
			<div class="success_msg">Last annotation has been successfully saved.</div>
		{% endif %}
		<h2>The dialogue</h2>
		<div>
		<form action="" method="POST" id="phases" class="accordion">
			{{ form.non_field_errors }}
			{% csrf_token %}
			{{ form.cid }}
		{% for turn in turns %}
			{% if not USE_ACCORDION %}
			<hr>
			{% else %}
			<h3 id="turn_{{ turn.turn_number }}" class="head ui-state-disabled">
				<a href="#">Turn {{ turn.turn_number }}</a>
			</h3>
			{% endif %}
			<div>
				{% if turn.prompt %}
				<div class="speaker">
					Computer{% if not USE_ACCORDION %} &ndash; {{ turn.turn_number }}{% endif %}:
				</div>
				<p class="system">{{ turn.prompt }}</p>
				{% endif %}
			{% if turn.has_rec %}
				<div class="speaker">
					Human{% if not USE_ACCORDION %} &ndash; {{ turn.turn_number }}{% endif %}:
					{% if 'asr' not in TASKS %}
					<span class="user">{{ turn.hypothesis }}</span>
					{% endif %}
				</div>
				{% if 'asr' in TASKS %}
				<div>
					<textarea cols="60" rows="2" style="width: 90%; max-width: 60em;"
						id="id_trs_{{ turn.turn_number }}" name="trs_{{ turn.turn_number }}"
						tabindex="{{ turn.dbl_turn_num|add:1 }}"></textarea>
				</div>
				{% endif %}
				<div>
					<button type="button" id="btnnext{{ turn.turn_number }}" class="btnnext"
						tabindex="{{ turn.dbl_turn_num }}"
						onclick="play_now('btnnext{{ turn.turn_number }}',
														  'turn_{{ turn.turn_number }}',
															'{{ app_url }}/data/recs{{ turn.rec }}');">Play</button>
				</div>
			{% else %}
				<div>
					<button type="button" class="btnnext{{ turn.turn_number }}" 
						tabindex="{{ turn.dbl_turn_num }}"
					 onclick="pseudo_play_now('btnnext{{ turn.turn_number }}', 'turn_{{ turn.turn_number }}', '');" class="btnnext">Next</button>
				</div>
			{% endif %}
			
			</div>
		{% endfor %}
	
			{% if not USE_ACCORDION %}<hr>{% endif %}
			<h3 id="phase_answer"
				class="head{% if USE_ACCORDION %} ui-state-disabled">
				<a href="#">Submit</a>
				{% else %}">Submit{% endif %}
			</h3>
			<div>
				<table>
					{% if "quality" in EXTRA_QUESTIONS %}
					<tr>
						<td>What was the quality of the recording?</td>
						<td>
							<input id="id_quality_noisy" name="quality" type="radio" 
								value="noisy">
									noisy</input>
						</td>
						<td>
							<input id="id_quality_clear" name="quality" type="radio" 
								value="clear" checked
								tabindex="{{ dbl_num_turns|add:1 }}">
									clear</input>
						</td>
					</tr>
					{% endif %}
					{% if "accent" in EXTRA_QUESTIONS %}
					<tr>
						<td>What accent did the speaker have?</td>
						<td>
							<input id="id_accent_native" name="accent" type="radio" 
								value="native" checked
								tabindex="{{ dbl_num_turns|add:2 }}">
									native English</input>
						</td>
						<td>
							<input id="id_accent_other" name="accent" type="radio" 
							value="other">other</input>
						</td>
					</tr>
					<tr id="accent_spec">
						<td>
							<label for="id_accent_name">What accent did you hear?</label>
						</td>
						<td>
							<input type="text" id="id_accent_name" name="accent_name" 
								size="30"
								tabindex="{{ dbl_num_turns|add:3 }}">
						</td>
					</tr>
					{% endif %}
					{% if "offensive" in EXTRA_QUESTIONS %}
					<tr>
						<td>Was offensive language used in the dialogue?</td>
						<td>
							<input id="id_offensive_yes" name="offensive" type="radio" 
								value="yes">
									yes</input>
						</td>
						<td>
							<input id="id_offensive_no" name="offensive" type="radio" 
							value="no" checked
								tabindex="{{ dbl_num_turns|add:4 }}">no</input>
						</td>
					</tr>
					{% endif %}
					<tr>
						<td colspan="3">
							<label for="id_notes">Should you have any comments to the 
						dialogue, you can write them down to the box below:</label>
						</td>
					</tr>
					<tr>
						<td colspan="3">
							<textarea id="id_notes" name="notes" cols="50" rows="3"></textarea>
						</td>
					</tr>
					<tr>
						<td colspan="3">
							<input id="submit" type="submit" name="send" value="Save transcription"
											tabindex="{{ dbl_num_turns|add:5 }}">
						</td>
					</tr>
				</table>
			</div>
		</form>
		</div>
	</div>	<!-- end div id="rg" -->
</span>

{% if form.errors %}
<script>
$(document).ready(function() {
{% if USE_ACCORDION %}
$(".ui-state-disabled").removeClass("ui-state-disabled");
{% endif %}
$("#phase_answer").click();
});
</script>
{% endif %}

<div id="player">
</div>
{% endblock content %}
