{% extends "base.html" %}

{% block head %}
<script src="http://vystadial.ms.mff.cuni.cz/apps/transcription/media/js/easyXDM.debug.js" type="text/javascript"></script>
<script type="text/javascript">
<!--
	var socket = new easyXDM.Socket({
			onReady:  function(){
					socket.postMessage(document.body.scrollHeight);
		 }
	});
//-->
</script>
<link href="{{ MEDIA_URL }}css/jquery-ui.css" rel="stylesheet" type="text/css"/>
<style type="text/css">
hr {
  margin: 20px;
}

form label {
    vertical-align: top;
    display: block;
}

div#ins, div#dg {
	display: inline-block;
}

div#ins {
	margin: 1em 2ex 0ex 2ex;
	min-width: 45em;
	max-width: 55em;
}

div#dg {
	width: 60em;
	max-width: 60em;
}

input#ins-hide {
	float: right;
	margin-right: 1em;
}

.quote {
	margin-left: auto;
	margin-right: auto;
	width: 80%;
}

.no {
	color: red;
	font-weight: bold;
}

.yes {
	color: green;
	font-weight: bold;
}

ul.errorlist {
    color: red;
    display:block;
}

div#task {
  xborder: 1px solid red;
  xbackground-color: #FFCCCC;
  margin-top: 20px;
  margin: 5px;
  padding: 5px;
}

div#goal {
  border: 1px solid yellow;
  background-color: #FFFFCC;
  margin-top: 20px;
  margin: 5px;
  padding: 5px;
}

p.tasktext {
  font-weight: bold;
  color: red;
  padding-top: 5px !important;
}

p.goaltext, #task p {
  padding: 0px;
  margin: 0px;
}

.speaker {
	position: relative;
	left: -1em;
	font-weight: bold;
}


/* Tables */
table.booktabs	{
	margin-top: 1em;
	margin-bottom: 2em;
	border-bottom: 1.5pt solid;
	border-top: 1.5pt solid;
	border-spacing: 1em;
	border-collapse: collapse;
}

td, th {
	padding: 5px;
}

table.booktabs td + td, table.booktabs th + th
{
	padding-left: 2em;
}

table.booktabs tr:first-child {
	border-bottom: 1pt solid;
}

table.booktabs.noheader tr:first-child {
	border-bottom: inherit;
}

form li {
  list-style-type: none;
  padding-top: 10px;
}

p.system { color: blue; }
p.user { color: orange; }

.errors {
    background-color: red;
    color: white;
}

#submit {
  width: 120px;
  height: 50px;
  font-weight: bold;
}

</style>
<script src="{{ MEDIA_URL }}js/jquery.js"></script>
<script src="{{ MEDIA_URL }}js/jquery.multi-open-accordion.js"></script>
<script src="{{ MEDIA_URL }}js/jquery-ui.min.js"></script>
<script src="{{ MEDIA_URL }}js/jquery.jplayer.min.js"></script>
<script type="text/javascript">
    String.prototype.endsWith = function(suffix) {
        return this.indexOf(suffix, this.length - suffix.length) !== -1;
    };
    var curr_btnid = "";

    var beenPlaying = false;

  function getPlayer(pid) {
      var obj = document.getElementById(pid);
      if (obj.doPlay) return obj;
      for(i=0; i<obj.childNodes.length; i++) {
          var child = obj.childNodes[i];
          if (child.tagName == "EMBED") return child;
      }
  }

  function NextPhase() {
      var PrevIndex = $('div .current');
      var NextIndex = PrevIndex.next().next();
      PrevIndex.removeClass("current");
      NextIndex.addClass("current");
      //NextIndex.click();

      NextIndex.removeClass("ui-state-disabled");
      if(!NextIndex.hasClass("ui-state-active"))
          NextIndex.click();
  }

  function PlayerStopped() {
      if(beenPlaying) {
          beenPlaying = false;
          $('#' + curr_btnid).text("Play");

          NextPhase();
      }
  }

  function PlayerPlaying() {
      beenPlaying = true;
  }

  function init_player(name) {
      var player = getPlayer(name);
      var init = function() { init_player(name); }
      if (!player || !player.attachHandler) setTimeout(init, 100); // Wait for load
      else {
          player.attachHandler("PLAYER_PLAYING", "PlayerPlaying", "STOPPED");
          player.attachHandler("PLAYER_STOPPED", "PlayerStopped", "STOPPED");
          //window.TinyWav = new TinyWav('TinyWavBlock', 0.01);
      }
  }

  function deinit_player(name) {
      var player = getPlayer(name);
      var init = function() { init_player(name); }
      if (!player || !player.attachHandler) setTimeout(init, 100); // Wait for load
      else {
          player.removeHandler(PlayerStopped);
      }
  }

  var accordion, hideButton, insAreShown = true;

	// Callback function called when the instructions have been hidden.
	function insHidden() {
		insAreShown = false;
		hideButton.value = "Show instructions";
		hideButton.disabled = false;
	}

	// Callback function called when the instructions have been shown.
	function insShown() {
		insAreShown = true;
		hideButton.value = "Hide instructions";
		hideButton.disabled = false;
	}

  $(document).ready(function() {
      accordion = $("#phases").multiAccordion({active: 0});

      $("#player").jPlayer( {
          swfPath: "{{ MEDIA_URL }}flash/",
          supplied: "wav",
          ended: function() {
              PlayerStopped();
          }
      });

      $("#turn_1").removeClass("ui-state-disabled");

			$('body').keydown(function(e) {
          var code = e.keyCode || e.which;
          if (code == '9') {
              var curid =$("*:focus").attr("id");
              var buttons = $(".btnnext");
              for(var i = 0; i < buttons.length; i++) {
                  if(buttons[i].id == curid) {
                      $("#" + buttons[i + 1].id)[0].focus();
                      return false;
                  }
              }
          }
      });

      $("#submit").click(function() {
					// Check that all fields (text areas) are filled in.
					var res = 1;
					var fields = document.getElementsByTagName("textarea");
					for(var fldIdx = 0; fldIdx < fields.length; fldIdx++)
					{
						if(fields[fldIdx].value.search(/\w/) === -1)
						{
							res = 0;
							break;
						}
					}

					if(res !== 1) {
						msg = "Please fill in all the input fields.\n";
						msg += "In case you heard just silence, type \"(sil)\" ";
						msg += "into the corresponding field.\n";
						msg += "See Instructions for transcription of other ";
						msg += "non-speech sounds.";
						alert(msg);
						return false;
          }
          return true;
      });

			hideButton = document.getElementById("ins-hide");
			$("input#ins-hide").click(function() {
				hideButton.disabled = true;
				if(insAreShown)
				{
					$("div#ins-inner").slideUp("fast", "swing", insHidden);
				}
				else
				{
					$("div#ins-inner").slideDown("fast", "swing", insShown);
				}
			});
  });

  function play_now(btnid, phase, f) {
      curr_btnid = btnid;
      $(".current").removeClass("current");
      $("#" + phase).addClass("current");
      try{
          PlayerPlaying();
          $('#' + btnid).text("Playing...");
          $("#player").jPlayer("setMedia", {wav: f}).jPlayer("play");
      } catch(E){
          alert(E);
      }
  }
</script>

{% endblock head %}


{% block content %}


<span>
	<div id="ins">
		<h2>Instructions
			<input type="button" id="ins-hide" value="Hide instructions"></input>
		</h2>
		
		<div id="ins-inner">
			<p>
			The recordings and input fields will be enabled gradually, each time you 
			finish listening to the previous recording. You can replay each sound any 
			time later.
			</p>

			<h3>Ortography</h3>
			<p>
			Please, try to avoid spelling errors. Punctuation and capitalisation 
			generally do not matter. The exception is with acronyms &ndash; 
			please transcribe acronyms in uppercase letters.
			</p>

			<h3>Numerals</h3>
			<p>
			Please, do <em>not</em> use numbers to transcribe numerals; 
			spell them out:
			<div class="quote">
				<table>
					<tr>
						<td>53</td>
						<td class="no">NO</td>
					<tr>
						<td>fifty three</td>
						<td class="yes">YES</td>
					</tr>
				</table>
			</div>
			</p>

			<h3>Incomplete Words</h3>
			<p>
			If a word is pronounced incomplete, put &lsquo;-&rsquo; (dash) before 
			or after the pronounced part of the word.
			</p>
			<p>
			<strong>Examples:</strong> incomp- -eech -crastinat-
			</p>

			<h3>Non-speech Sounds</h3>
			<p>
			For non-speech sounds, you can transcribe them using the following symbols:
			</p>
	
			<table class="booktabs">
				<tr>
					<th>symbol</th>
					<th>meaning</th>
				</tr>
				<tr>
					<td>(breath)</td>
					<td>the sound of breathing, sniffing etc.</td>
				</tr>
				<tr>
					<td>(cough)</td>
					<td>the sound of coughing</td>
				</tr>
				<tr>
					<td>(hum)</td>
					<td>humming (all of <em>hum</em>, <em>erm</em>, <em>ehm hmm</em> 
							etc.)</td>
				</tr>
				<tr>
					<td>(laugh)</td>
					<td>laughter</td>
				</tr>
				<tr>
					<td>(noise)</td>
					<td>noise on the background</td>
				</tr>
				<tr>
					<td>(sil)</td>
					<td>silence if it is prominent or if there is nothing else to transcribe</td>
				</tr>
				<tr>
					<td>(unint)</td>
					<td>unintelligible speech</td>
				</tr>
			</table>

			<h3>Local Names</h3>
			<p>
			The following table lists the correct spelling of some place names 
			that could otherwise be problematic to transcribe:
			</p>
			<div class="quote">
				<table class="booktabs noheader">
					<tr><td>Addenbrooke's</td>     <td>Girton</td>      <td>Chesterton</td></tr>
					<tr><td>Gonville and Caius</td><td>Castlehill</td>  <td>Romsey</td></tr>
					<tr><td>Barnwell</td>          <td>Huntingdon</td>  <td>Coco</td></tr>
					<tr><td>Fenditton</td>         <td>Cherryhinton</td><td>Trumpington</td></tr>
					<tr><td>Brasserie</td>         <td>Newnham</td>     <td></td></tr>
				</table>
			</div>

			<p>
			Please, <strong>DO NOT SPAM</strong>. We will check the responses, 
			and reject all responses from spammers.
			</p>
		</div>
	</div>
	
	<div id="dg">
		<h2>The dialogue</h2>
		<div>
		<form action="" method="POST" id="phases" class="accordion">
			{{ form.non_field_errors }}
			{% csrf_token %}
			{{ form.cid }}
		{% for turn in dialogue.turns %}
			<h3 id="turn_{{ turn.id }}" class="head ui-state-disabled">
				<a href="#">Turn {{ turn.id }}</a>
			</h3>
			<div>
				<div class="speaker">
					Computer:
				</div>
				<p class="system">{{ turn.prompt }}</p>
			{% if turn.has_rec %}
				<div class="speaker">
					Human:
				</div>
				<div>
					<button type="button" id="btnnext{{ turn.id }}" class="btnnext"
						tabindex="{{ turn.dbl_rec_num|add:1 }}"
						onclick="play_now('btnnext{{ turn.id }}', 'turn_{{ turn.id }}','{{ dialogue.path }}/{{ turn.rec }}')">Play</button>
				</div>
				<div>
					<textarea cols="60" rows="2" style="width: 90%; max-width: 60em;"
						id="id_trs_{{ turn.id }}" name="trs_{{ turn.id }}"
						tabindex="{{ turn.dbl_rec_num|add:2 }}"></textarea>
				</div>
			{% else %}
				<div>
					<button type="button" class="btnnext" onclick="NextPhase()" class="btnnext">Next</button>
				</div>
			{% endif %}
			
			</div>
		{% endfor %}
	
			<h3 id="phase_answer" class="head ui-state-disabled">
				<a href="#">Submit</a>
			</h3>
			<div>
				<input id="submit" type="submit" name="send" value="Save transcription"
								tabindex="{{ dialogue.dbl_num_recs|add:1 }}">
			</div>
		</form>
		</div>
	</div>	<!-- end div id="rg" -->
</span>

{% if form.errors %}
<script>
$(document).ready(function() {
$(".ui-state-disabled").removeClass("ui-state-disabled");
$("#phase_answer").click();
});
</script>
{% endif %}

<div id="player">
</div>
{% endblock content %}



