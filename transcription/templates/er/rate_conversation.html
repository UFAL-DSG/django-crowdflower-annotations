{% extends "base.html" %}

{% block heading %}
| Rated dialogs: {{ dialogs_rated }}
| Remaining dialogs: {{ dialogs_remaining }}
{% endblock %}

{% block head %}
<link href="/media/css/jquery-ui.css" rel="stylesheet" type="text/css"/>
<style type="text/css">
hr {
  margin: 20px;
}

form label {
    vertical-align: top;
    display: block;
}

div#instruct {
	color: green;
	padding-top: 10px;
}

ul.errorlist {
    color: red;
    display:block;
}

div#task {
  xborder: 1px solid red;
  xbackground-color: #FFCCCC;
  margin-top: 20px;
  margin: 5px;
  padding: 5px;
}

div#goal {
  border: 1px solid yellow;
  background-color: #FFFFCC;
  margin-top: 20px;
  margin: 5px;
  padding: 5px;
}

p.tasktext {
  font-weight: bold;
  color: red;
  padding-top: 5px !important;
}

p.goaltext, #task p {
  padding: 0px;
  margin: 0px;
}

form li {
  list-style-type: none;
  padding-top: 10px;
}

h4.system { color: blue; }
h4.user { color: orange; }
xh4.system { background-color: #EBEDFF; }
xh4.user { background-color: #FAFFC9; }

.errors {
    background-color: red;
    color: white;
}

#submit {
  width: 120px;
  height: 50px;
  font-weight: bold;
}

#sticky {
  background-color: white;
  z-index: 100;
}

#sticky.clone {
    border-bottom: 1px solid #666;
}

div.answer {
    margin-top: 10px;
}

div.hradio label {
    display: inline;
    margin-bottom: 20px;
    margin-left: 20px;
}

div.answer {
    border-top: 1px solid black;
    margin-top: 15px;
    padding: 5px;
}

div.hradio {
    margin-top: 10px;

    xborder-bottom: 1px solid black;
    margin-bottom: 5px;
}

.scale0 {
    color: green;
    font-weight: bold;
}
.scale1 {
    color: #33CC66;
}
.scale2 {
    color: #666;
}
.scale3 {
    color: #FF6600;
}
.scale4 {
    color: red;
    font-weight: bold;
}

</style>
<script src="/media/js/jquery.js"></script>
<script src="/media/js/jquery.multi-open-accordion.js"></script>
<script src="/media/js/jquery-ui.min.js"></script>
<script src="/media/js/jquery.jplayer.min.js"></script>
<script type="text/javascript">
    String.prototype.endsWith = function(suffix) {
        return this.indexOf(suffix, this.length - suffix.length) !== -1;
    };
    var curr_btnid = "";

    var beenPlaying = false;

  function getPlayer(pid) {
      var obj = document.getElementById(pid);
      if (obj.doPlay) return obj;
      for(i=0; i<obj.childNodes.length; i++) {
          var child = obj.childNodes[i];
          if (child.tagName == "EMBED") return child;
      }
  }

  function NextPhase() {
      var PrevIndex = $('div .current');
      var NextIndex = PrevIndex.next().next();
      PrevIndex.removeClass("current");
      NextIndex.addClass("current");
      //NextIndex.click();

      NextIndex.removeClass("ui-state-disabled");
      if(!NextIndex.hasClass("ui-state-active"))
          NextIndex.click();
  }

  function PlayerStopped() {
      if(beenPlaying) {
          beenPlaying = false;
          $('#' + curr_btnid).text("Play");

          NextPhase();
      }
  }

  function PlayerPlaying() {
      beenPlaying = true;
  }

  function init_player(name) {
      var player = getPlayer(name);
      var init = function() { init_player(name); }
      if (!player || !player.attachHandler) setTimeout(init, 100); // Wait for load
      else {
          player.attachHandler("PLAYER_PLAYING", "PlayerPlaying", "STOPPED");
          player.attachHandler("PLAYER_STOPPED", "PlayerStopped", "STOPPED");
          //window.TinyWav = new TinyWav('TinyWavBlock', 0.01);
      }
  }

  function deinit_player(name) {
      var player = getPlayer(name);
      var init = function() { init_player(name); }
      if (!player || !player.attachHandler) setTimeout(init, 100); // Wait for load
      else {
          player.removeHandler(PlayerStopped);
      }
  }

  var accordion;
  $(document).ready(function() {
      accordion = $("#phases").multiAccordion({active: 0});

      var stickyHeaderTop = $('#sticky').offset().top;
      var stickyOrig = $('#sticky');
      var sticky = stickyOrig.clone();
      sticky.addClass('clone');
      sticky.css({position: 'fixed', top: '0px'});
      sticky.appendTo('body');
      sticky.hide();
      sticky.width(stickyOrig.width() + 10);

      $(window).scroll(function() {
          if( $(window).scrollTop() > stickyHeaderTop ) {
              sticky.show();
          } else {
              sticky.hide();
          }
      });

      $("#player").jPlayer( {
          swfPath: "/media/flash/",
          supplied: "wav",
          ended: function() {
              PlayerStopped();
          }
      });

      $("#turn_1").removeClass("ui-state-disabled");

      //$("#turn_1").click();
      {% for i in rating_form.fields %}
      {% if "comment_" in i %}
      $("#id_{{ i }}").parent().hide();
      {% endif %}
      {% endfor %}


      $(".answer").find("input").click(function() {
          if($(this).parent().index() != 0) {
              $(this).parents('.answer').next("div").show();
          } else {
              $(this).parents('.answer').next("div").hide();
          }
      });

      $(".answer").find("label").each(function() {
          if($(this).parents('.answer').next('div').length > 0)
              $(this).addClass("scale" + $(this).index());
      });
      /*
      {% for i in rating_form.fields %}
      {% if "custom_" in i %}
      {% if not "comment_" in i %}
      $("#id_{{ i }}_1").click(
          function() {
              $("#id_comment_{{ i }}").parent().show();
          }
      );
      $("#id_{{ i }}_2").click(
          function() {
              $("#id_comment_{{ i }}").parent().show();
          }
      );
      $("#id_{{ i }}_3").click(
          function() {
              $("#id_comment_{{ i }}").parent().show();
          }
      );
      $("#id_{{ i }}_4").click(
          function() {
              $("#id_comment_{{ i }}").parent().show();
          }
      );
      {% endif %}
      {% endif %}
      {% endfor %}
      */

      $('body').keydown(function(e) {
          var code = e.keyCode || e.which;
          if (code == '9') {
              var curid =$("*:focus").attr("id");
              var buttons = $(".btnnext");
              for(var i = 0; i < buttons.length; i++) {
                  if(buttons[i].id == curid) {
                      $("#" + buttons[i + 1].id)[0].focus();
                      return false;
                  }
              }
          }
      });

      $("#submit").click(function() {
          var checkChecked = function(v) {
              if($("form input[name=" + v + "]:checked").length == 0)
                  return false;
              return true;
          }
          var checkVal = function(v) {
              if(!checkChecked(v))
                  return false;
              if($("form :input[name=" + v + "]").parents(".answer").next().css("display") != "none") {
                  if($("textarea[name=comment_" + v + "]").val().length == 0) {
                      return false;
                  }
              }
              return true;
          };
          var res = 1;
          res &= checkVal("custom_asked_all");
          res &= checkVal("custom_is_genuine");
          res &= checkVal("custom_provide_all");
          res &= checkChecked("custom_user_mode");


          if(res != 1) {
              alert("Please fill in all the required fields and comments of the answer form.");
              return false;
          }
          return true;
      });
  });

  function play_now(btnid, phase, f) {
      curr_btnid = btnid;
      $(".current").removeClass("current");
      $("#" + phase).addClass("current");
      try{
          PlayerPlaying();
          $('#' + btnid).text("Playing..");
          $("#player").jPlayer("setMedia", {wav: f}).jPlayer("play");
      } catch(E){
          alert(E);
      }
  }
</script>

{% endblock head %}


{% block content %}


<h1>Rating phone conversations with an automated restaurant information system</h1>
<h2>Instructions</h2>

<p>Imagine you are listening in on a phone conversation in which someone is talking to an automated restaurant information system, trying to find a suitable restaurant. We ask you to rate such conversation by looking at their transcription and then fill out a small questionnaire.

<p>Please read and play the first turn. When the playback is finished, you can play and read the next turn.

<div id="sticky">
<div id="instruct">
Please carefully listen to each user utterance and read the system responses, and try to determine:
<ol>
{% for q in questions %}
<li>
{{ q.text }}
</li>
{% endfor %}
</ol>
</div>
<h2>User's task</h2>
<ul>
<li>
<div id="task">
<p>Task:
<p class="tasktext">{{ feedback.task }}
</div>
</li>
<li>
<div id="goal">
<p class="goaltext">Goal:
<ul>
<li>
 The user should be looking for <b>{{ feedback.get_goal_what }}</b>. </li>
<li>
 The user should constrain their search by: <b>{{ feedback.get_goal_constraint }}</b>. </li>
<li>
 The user should ask for: <b>{{ feedback.get_goal_what_info }}</b>. </li>
</ul>
</div>
</li>
</ul>
</div>


<h2>Conversation turns</h2>
<div id="phases" class="accordion">
{% for turn in dialog.turns %}
<h3 id="turn_{{ turn.id }}" class="head ui-state-disabled"><a href="#">Turn {{ turn.id }}</a></h3>
<div>
System's prompt: <h4 class="system">{{ turn.prompt }}</h4>
{% if turn.transcription %}
User's answer: <h4 class="user">
{{ turn.transcription }}
</h4>
{% else %}
{% endif %}

<p>
{% if turn.rec %}
<button id="btnnext{{ turn.id }}" class="btnnext" onclick="play_now('btnnext{{ turn.id }}', 'turn_{{ turn.id }}','{{ dialog.path }}/{{ turn.rec }}')">Play</button><br/>

{% else %}
<button class="btnnext" onclick="NextPhase()" class="btnnext">Next</button>

{% endif %}

</div>


{% endfor %}

<h3 id="phase_answer" class="head ui-state-disabledx"><a href="#">Answers</a></h3>
<div>
<form action="" method="POST">
{{ form.non_field_errors }}
{% csrf_token %}
{% for field in rating_form %}
{{ field.errors }}
{% if 'comment' in field.name %}
<div>{{ field }}</div>
{% else %}
{% if not field.is_hidden %}
<div class="answer {% if field.errors %}errors{% endif %}">
{{ field.label }} <div class="hradio">{{ field }}</div>
</div>
{% else %}
{{ field }}
{% endif %}
{% endif %}
{% endfor %}
<input id="submit" type="submit" name="send" value="Submit">
<input type="hidden" name="cid" value="">
</form>
</div>
</div>

{% if rating_form.errors %}
<script>
$(document).ready(function() {
$(".ui-state-disabled").removeClass("ui-state-disabled");
$("#phase_answer").click();
});
</script>
{% endif %}

<div id="player">
</div>
{% endblock content %}
